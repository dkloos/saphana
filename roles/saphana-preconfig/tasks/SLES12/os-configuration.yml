---
- name: " Stage 2.2 -   Check / set hostname"
  hostname:
    name: "{{ host.name }}"

- name: " Stage 2.2 -   Setting correct hostname in /etc/hosts"
  lineinfile:
    path: /etc/hosts
    regexp: "{{ host.name }}"
    line: "{{ host.interface.public.ip }}  {{ host.name }}.{{ host.domain }}  {{ host.name }}"

- name: " Stage 2.2 -   Setting DNS config"
  blockinfile:
    path: /etc/resolv.conf
    block: "nameserver {{ item }}"
    marker: "# {mark} ANSIBLE MANAGED BLOCK {{ item }}"
  with_items: "{{ host.nameserver }}"

- name: " Stage 2.2 -  Remove DVD repo"
  zypper_repository:
    state: absent
    name: 'SLE-12-SP3-SAP-12.3-0'

- name: check regitered status
  shell: SUSEConnect -s
  register: regstatus
  when: ( not  ( host.registration.regcode is undefined) or ( host.registration.regcode is none) or (host.registration.regcode is undefined | trim == '') or (host.registration.email is undefined) or (host.registration.email is none) or (registration.email is undefined | trim == '') )
  changed_when: false

- name: " Stage 2.2 -   Register system"
  shell: "SUSEConnect -r {{ host.registration.regcode }} -e {{ host.registration.email }}"
  when: ("Not Registered" in regstatus.stdout)


- name: " Stage 2.2 -   Refresh all repos"
  zypper_repository:
    repo: '*'
    runrefresh: yes

- name: " Stage 2.2 -  Update installed packags"
  zypper:
    state: latest
    name: '*'

- name: " Stage 2.2 - Comair Kernel versions"
  shell: if [ $(zypper if kernel-default |grep Version |cut -d':' -f2|cut -d'-' -f1|tr -d ' ') != $(uname -r |cut -d'-' -f1|tr -d ' ') ];then echo "reboot"; fi
  changed_when: false
  register: compair_kernel
  
- name: " Stage 2.2 -  Restart system to reboot to newest kernel"
  shell: "sleep 5 && /sbin/shutdown -r now"
  async: 1
  poll: 0
  when: (compair_kernel.stdout == "reboot")

- name: " Stage 2.2 -  Wait for system to become reachable again"
  wait_for_connection:
    delay: 60
    timeout: 300
  when: (compair_kernel.stdout == "reboot")

- name: " Stage 2.2 -  Install required packages"
  zypper:
    state: latest
    name: "{{ item }}"
  with_items:
    - tuned
    - nfs-utils
    - saptune
    - uuidd

- name: " Stage 2.2 -   Setting NTP server"
  block:
   - blockinfile:
       path: /etc/ntp.conf
       block: "server {{ host.ntpserver }} iburst"
     notify: restart ntp
   - timezone:
       name: "{{ host.timezone }}"
     notify: restart ntp
  when: not( (host.ntpserver is undefined) or (host.ntpserver is none) or (host.ntpserver | trim == '') )


### TODO: Configure Firewall according to instance number instead of disabling
- name: " Stage 2.2 -  Configure Services"
  service: 
    name: "{{ item.name }}"
    state: "{{ item.state }}"
    enabled: "{{ item.enabled }}"
  with_items:
    - { name: 'SuSEfirewall2', state: 'stopped', enabled: 'no' }
    - { name: 'kdump', state: 'stopped', enabled: 'no' }
    - { name: 'uuidd', state: 'started', enabled: 'yes' }
    - { name: 'tuned', state: 'started', enabled: 'yes' }
    - { name: 'ntpd', state: 'started', enabled: 'yes' }
